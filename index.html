<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小红书博主预约解析器 (Web版)</title>
    <!-- 1. 加载 Tailwind CSS 用于美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. 加载 SheetJS (xlsx.js) 用于在浏览器中读取 Excel 文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 增加一个自定义样式，用于美化文件上传按钮 */
        input[type="file"]::file-selector-button {
            @apply bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 cursor-pointer border-0 hover:bg-blue-700;
        }
        input[type="file"]::file-selector-button:active {
            @apply bg-blue-800;
        }
        /* 美化复选框 */
        input[type="checkbox"] {
            @apply h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal">

    <div class="container mx-auto max-w-4xl p-5 md:p-8">
        
        <!-- 顶部标题和链接 -->
        <header class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-4">
                小红书博主探店预约解析器
            </h1>
            <div class="text-center">
                <a href="https://jinshuju.net/forms/Mhc1wf/entries" target="_blank" rel="noopener noreferrer" 
                   class="text-blue-600 hover:text-blue-800 hover:underline font-medium text-sm transition-colors duration-200">
                    点击访问数据后台 (jinshuju.net)
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- 左侧控制面板 -->
            <aside class="md:col-span-1 space-y-6">

                <!-- 1. 选择文件 -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <label class="text-lg font-semibold text-gray-700 mb-3 block">
                        1. 选择 Excel/CSV 文件
                    </label>
                    <input type="file" id="file-upload" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:cursor-pointer" 
                           accept=".xlsx, .xls, .csv">
                    <div id="loading-spinner" class="hidden text-sm text-blue-600 animate-pulse mt-3">
                        正在解析文件...
                    </div>
                    <div id="error-message" class="hidden text-sm text-red-600 font-medium mt-3"></div>
                    <div id="success-message" class="hidden text-sm text-green-600 font-medium mt-3"></div>
                </div>

                <!-- 2. 选择餐厅 -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <label class="text-lg font-semibold text-gray-700 mb-3 block">
                        2. 选择餐厅
                    </label>
                    <!-- 可滚动的复选框容器 -->
                    <div id="restaurant-list-container" 
                         class="h-48 overflow-y-auto border border-gray-200 rounded-lg p-3 space-y-2 bg-gray-50">
                        <span class="text-gray-500 text-sm">请先上传文件...</span>
                    </div>
                </div>

                <!-- 3. 筛选选项 -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <label class="text-lg font-semibold text-gray-700 mb-3 block">
                        3. 筛选选项
                    </label>
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="filter-exclude-sent">
                        <label for="filter-exclude-sent" class="text-sm text-gray-600">
                            排除“已发送给店家”的数据
                        </label>
                    </div>
                </div>

                <!-- 4. 显示选项 -->
                <div class="bg-white p-5 rounded-xl shadow-lg">
                    <label class="text-lg font-semibold text-gray-700 mb-3 block">
                        4. 显示选项
                    </label>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="display-restaurant">
                            <label for="display-restaurant" class="text-sm text-gray-600">显示餐厅</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="display-link">
                            <label for="display-link" class="text-sm text-gray-600">显示小红书链接</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="display-status">
                            <label for="display-status" class="text-sm text-gray-600">显示发送状态</label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 右侧结果显示 -->
            <main class="md:col-span-2 bg-white p-5 rounded-xl shadow-lg">
                <h2 id="results-label" class="text-lg font-semibold text-gray-700 mb-4 pb-3 border-b border-gray-200">
                    5. 解析结果：
                </h2>
                <pre id="results-output" 
                     class="w-full h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg text-sm text-gray-700 whitespace-pre-wrap font-mono"
                     style="min-height: 500px;"></pre>
            </main>
        </div>
    </div>

    <script>
        // --- 全局变量 ---
        let globalData = []; // 存储解析后的数据, 类似于 global_df
        const requiredCols = ['预约日期', '小红书名', '小红书粉丝数', '预约餐厅', '已发送给店家', '小红书链接'];
        
        // 定义星期几的映射 (JS: 0=周日, 1=周一, ..., 6=周六)
        const WEEKDAY_MAP_JS = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        
        // 格式化数字 (用于粉丝量)
        const numberFormatter = new Intl.NumberFormat('en-US');

        // --- DOM 元素引用 ---
        const fileInput = document.getElementById('file-upload');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const restaurantContainer = document.getElementById('restaurant-list-container');
        const resultsLabel = document.getElementById('results-label');
        const resultsOutput = document.getElementById('results-output');
        
        // 筛选和显示复选框
        const filterExcludeSent = document.getElementById('filter-exclude-sent');
        const displayRestaurant = document.getElementById('display-restaurant');
        const displayLink = document.getElementById('display-link');
        const displayStatus = document.getElementById('display-status');

        // --- 事件监听 ---
        
        // 1. 监听文件上传
        fileInput.addEventListener('change', handleFileSelect);

        // 2. 监听所有筛选/显示选项的变化
        [filterExcludeSent, displayRestaurant, displayLink, displayStatus].forEach(checkbox => {
            checkbox.addEventListener('change', updateDisplay);
        });

        // 3. 监听餐厅列表中的复选框变化 (使用事件委托)
        restaurantContainer.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                updateDisplay();
            }
        });

        // --- 核心功能函数 ---

        /**
         * 1. 当用户选择文件时触发
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 显示加载提示，重置状态
            loadingSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
            restaurantContainer.innerHTML = '<span class="text-gray-500 text-sm">正在解析...</span>';
            resultsOutput.textContent = '';
            resultsLabel.textContent = '5. 解析结果：';
            globalData = [];

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // [修正] 关键改动：
                    // 不再使用 sheet_to_json(worksheet)
                    // 而是使用 { header: 1 } 将整个工作表转为一个数组的数组
                    // e.g., [ ['表头1', '表头2'], ['数据1', '数据2'] ]
                    // 这样我们可以手动清理表头，避免 SheetJS 的自动转换错误
                    const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    processData(dataAsArray);

                } catch (err) {
                    showError(`文件解析失败: ${err.message}`);
                    loadingSpinner.classList.add('hidden');
                }
            };

            reader.onerror = () => {
                showError('读取文件失败。');
                loadingSpinner.classList.add('hidden');
            };

            reader.readAsArrayBuffer(file);
        }

        /**
         * 2. [修正] 处理来自 SheetJS 的数组数据
         */
        function processData(dataAsArray) {
            // [修正] 检查数据（至少需要表头+1行数据）
            if (dataAsArray.length < 2) {
                showError('表格为空或只有表头。');
                loadingSpinner.classList.add('hidden');
                return;
            }

            // 1. [修正] 手动获取原始表头行
            const rawHeaders = dataAsArray[0];
            
            // 2. [修正] 手动清理表头 (强制转为字符串，移除BOM和空格)
            const headers = rawHeaders.map(h => {
                if (h == null) return ''; // 处理空表头
                return String(h).replace(/\ufeff/g, '').trim();
            });
            
            // 3. [修正] 检查必需的列
            const missingCols = requiredCols.filter(col => !headers.includes(col));
            if (missingCols.length > 0) {
                console.log("找到的表头 (原始):", rawHeaders);
                console.log("找到的表头 (已清理):", headers);
                console.log("需要的表头:", requiredCols);
                showError(`Excel 缺少必需列: ${missingCols.join(', ')}`);
                loadingSpinner.classList.add('hidden');
                return;
            }

            let uniqueRestaurants = new Set();
            globalData = [];
            
            // 4. [修正] 创建一个从“必需列”到“列索引”的映射
            // (例如: "预约餐厅" -> 1)
            const colIndexMap = {};
            requiredCols.forEach(reqCol => {
                const index = headers.indexOf(reqCol);
                if (index !== -1) {
                    colIndexMap[reqCol] = index;
                }
            });
            
            // 5. [修正] 获取数据行 (从第二行开始)
            const dataRows = dataAsArray.slice(1);

            // 6. [修正] 遍历数据行 (row 现在是一个数组)
            dataRows.forEach((row, index) => {
                // 使用映射后的索引 (colIndexMap) 来获取数据
                // [注意] SheetJS 在读取日期时，如果使用 {header: 1} 和 {cellDates: true}，
                // 它可能会返回一个对象 {t: 'd', v: ...} 而不是 Date 对象。
                // 我们需要更健壮地处理日期。
                const dtValue = row[colIndexMap['预约日期']];
                let dt = null;

                if (dtValue instanceof Date) {
                    dt = dtValue; // 已经是 Date 对象
                } else if (typeof dtValue === 'number') {
                    // 可能是 Excel 序列号
                    dt = XLSX.SSF.parse_date_code(dtValue);
                } else if (typeof dtValue === 'string') {
                    // 尝试解析字符串
                    dt = new Date(dtValue);
                }
                
                const restaurantName = row[colIndexMap['预约餐厅']];

                // 检查日期是否有效
                if (dt && !isNaN(dt.getTime())) {
                    
                    let trimmedRestaurantName = null;
                    // 添加餐厅到 Set
                    if (restaurantName) {
                        trimmedRestaurantName = String(restaurantName).trim();
                        // 过滤掉空字符串
                        if(trimmedRestaurantName) {
                            uniqueRestaurants.add(trimmedRestaurantName);
                        }
                    }

                    // [修正] 存储解析后的数据, 从数组构建对象
                    const normalizedRow = {};
                    for (const reqCol in colIndexMap) {
                        normalizedRow[reqCol] = row[colIndexMap[reqCol]];
                    }
                    
                    globalData.push({
                        ...normalizedRow, // 包含所有必需列
                        '预约日期_dt': dt, // 存储 JS Date 对象
                        '预约餐厅': trimmedRestaurantName // 存储已 trim 的名称
                    });
                } else {
                    // 忽略无效日期行
                }
            });

            // 按日期排序
            globalData.sort((a, b) => a['预约日期_dt'] - b['预约日期_dt']);

            // 隐藏加载
            loadingSpinner.classList.add('hidden');
            showSuccess(`文件加载成功。共发现 ${uniqueRestaurants.size} 家餐厅。`);

            // 填充餐厅复选框
            populateCheckboxes(uniqueRestaurants);

            // 更新一次显示 (显示 "共 0 条")
            updateDisplay();
        }

        /**
         * 3. 动态创建餐厅复选框
         */
        function populateCheckboxes(restaurantSet) {
            // [修正] 确保过滤掉 null 或空字符串
            const sortedRestaurants = Array.from(restaurantSet).filter(name => name && name.trim() !== "").sort();
            
            if (sortedRestaurants.length === 0) {
                restaurantContainer.innerHTML = '<span class="text-gray-500 text-sm">未在文件中找到餐厅。</span>';
                return;
            }

            let html = '';
            sortedRestaurants.forEach((name, index) => {
                const id = `restaurant-chk-${index}`;
                html += `
                    <div class="flex items-center">
                        <input type="checkbox" id="${id}" value="${name}" class="restaurant-checkbox">
                        <label for="${id}" class="ml-2 text-sm text-gray-700 truncate">${name}</label>
                    </div>
                `;
            });
            restaurantContainer.innerHTML = html;
        }

        /**
         * 4. 核心功能：当任何选项更改时，重新筛选并显示结果
         */
        function updateDisplay() {
            if (globalData.length === 0) {
                resultsLabel.textContent = `5. 解析结果： (共 0 条)`;
                resultsOutput.textContent = '';
                return;
            }

            // A. 获取所有选中的餐厅
            const selectedRestaurants = Array.from(
                restaurantContainer.querySelectorAll('.restaurant-checkbox:checked')
            ).map(cb => cb.value);

            // B. 获取筛选和显示选项
            const bExcludeSent = filterExcludeSent.checked;
            const bShowRestaurant = displayRestaurant.checked;
            const bShowLink = displayLink.checked;
            const bShowStatus = displayStatus.checked;

            // --- C. 开始筛选 ---
            let filteredData = [];

            // 1. 按餐厅筛选
            if (selectedRestaurants.length > 0) {
                filteredData = globalData.filter(row => 
                    selectedRestaurants.includes(row['预约餐厅'])
                );
            } else {
                // 如果没有选择餐厅，则不显示任何数据
                filteredData = [];
            }

            // 2. 按“排除已发送”筛选
            if (bExcludeSent) {
                filteredData = filteredData.filter(row => {
                    const status = row['已发送给店家'];
                    // 检查是否为 null, undefined, '否', 或 false
                    return status == null || status === '否' || status === false || String(status).trim() === '';
                });
            }

            // --- D. 格式化输出 ---
            const resultString = formatDataToString(
                filteredData, 
                bShowRestaurant, 
                bShowLink, 
                bShowStatus
            );

            // E. 更新 UI
            resultsLabel.textContent = `5. 解析结果： (共 ${filteredData.length} 条)`;
            resultsOutput.textContent = resultString;
        }

        /**
         * 5. 将筛选后的数据格式化为最终字符串
         */
        function formatDataToString(data, showRestaurant, showLink, showStatus) {
            if (data.length === 0) {
                return '没有找到匹配所选筛选条件的预约记录。';
            }

            const outputLines = data.map(row => {
                const recordLines = [];
                const dt = row['预约日期_dt'];

                // 1. 日期、星期、时间
                const dateStr = `${dt.getMonth() + 1}月${dt.getDate()}日`;
                const dayStr = `（${WEEKDAY_MAP_JS[dt.getDay()]}）`;
                const timeStr = formatTimeAMPM(dt);
                recordLines.push(`- ${dateStr}${dayStr} ${timeStr}`);

                // 2. 餐厅 (条件显示)
                if (showRestaurant) {
                    recordLines.push(`- 餐厅：${row['预约餐厅'] || '(空)'}`);
                }

                // 3. 博主 (始终显示)
                recordLines.push(`- 博主：${row['小红书名'] || '(空)'}`);

                // 4. 链接 (条件显示)
                if (showLink) {
                    const link = row['小红书链接'];
                    const linkStr = (link && String(link).trim() !== '') ? link : '(空)';
                    recordLines.push(`- 链接：${linkStr}`);
                }

                // 5. 粉丝量 (始终显示)
                try {
                    const count = parseInt(row['小红书粉丝数'], 10);
                    const followerStr = isNaN(count) ? row['小红书粉丝数'] : numberFormatter.format(count);
                    recordLines.push(`- 粉丝量：${followerStr || '0'}`);
                } catch (e) {
                    recordLines.push(`- 粉丝量：${row['小红书粉丝数'] || '(错误)'}`);
                }

                // 6. 状态 (条件显示)
                if (showStatus) {
                    const status = row['已发送给店家'];
                    let statusStr = "未知";
                    if (status == null || String(status).trim() === '') {
                        statusStr = "未发送";
                    } else if (status === '否' || status === false) {
                        statusStr = "未发送";
                    } else if (status === '是' || status === true) {
                        statusStr = "已发送";
                    } else {
                        statusStr = String(status);
                    }
                    recordLines.push(`- 状态：${statusStr}`);
                }
                
                return recordLines.join('\n');
            });

            return outputLines.join('\n\n'); // 每个条目之间用两个换行符隔开
        }


        // --- 辅助工具函数 ---

        /**
         * 格式化时间为 1:30pm 格式
         */
        function formatTimeAMPM(date) {
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0点是 12am
            minutes = minutes < 10 ? '0' + minutes : minutes;
            return `${hours}:${minutes}${ampm}`;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }
    </script>
</body>
</html>